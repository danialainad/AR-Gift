<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>AR Model Placer - Manual Coordinates</title>

  <!-- A-Frame + AR.js (location-based) -->
  <script src="https://aframe.io/releases/1.4.1/aframe.min.js"></script>
  <!-- AR.js location plugin (gps-entity-place, gps-camera) -->
  <script src="https://rawcdn.githack.com/AR-js-org/AR.js/3.4.0/aframe/build/aframe-ar.js"></script>
  <!-- Leaflet for map -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    body { margin:0; font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; }
    #ui {
      position: fixed;
      z-index: 999;
      left: 10px;
      top: 10px;
      background: rgba(255,255,255,0.95);
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0 6px 18px rgba(0,0,0,0.12);
      width: 350px;
      max-height: 90vh;
      overflow-y: auto;
    }
    #ui label { display:block; font-size:12px; margin-top:8px; color:#333; font-weight: 500; }
    #ui input, #ui select { width:100%; padding:8px; font-size:14px; margin-top:4px; box-sizing:border-box; border: 1px solid #ddd; border-radius: 4px; }
    #ui button { margin-top:10px; width:100%; padding:10px; font-size:15px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; }
    #ui button:hover { background: #0056b3; }
    #ui button:disabled { background: #ccc; cursor: not-allowed; }
    #notice { font-size:12px; color:#666; margin-top:8px; line-height: 1.4; }
    #linkOut { font-size:13px; word-break:break-all; margin-top:8px; background:#f6f6f6; padding:8px; border-radius:6px; border: 1px solid #ddd; }
    #map { height: 200px; width: 100%; margin-top: 8px; border-radius: 4px; border: 1px solid #ddd; }
    .tab-container { margin-bottom: 10px; }
    .tab-buttons { display: flex; margin-bottom: 10px; }
    .tab-button { flex: 1; padding: 8px; background: #f0f0f0; border: none; cursor: pointer; border-radius: 4px 4px 0 0; }
    .tab-button.active { background: #007bff; color: white; }
    .tab-content { display: none; }
    .tab-content.active { display: block; }
    .coordinate-inputs { display: flex; gap: 8px; }
    .coordinate-inputs input { flex: 1; }
    .loading { opacity: 0.6; pointer-events: none; }
  </style>
</head>
<body>

  <div id="ui">
    <h3 style="margin: 0 0 15px 0; color: #333;">AR Model Placer</h3>
    
    <div class="tab-container">
      <div class="tab-buttons">
        <button class="tab-button active" data-tab="coordinates">Coordinates</button>
        <button class="tab-button" data-tab="model">Model</button>
      </div>
      
      <div id="coordinates-tab" class="tab-content active">
        <label>Input Method
          <select id="inputMethod">
            <option value="manual">Manual Coordinates</option>
            <option value="map">Map Selection</option>
            <option value="gps">GPS Coordinates</option>
          </select>
        </label>
        
        <div id="manualInput">
          <label>X Coordinate (Longitude)
            <input id="lon" placeholder="e.g. 4.8897" type="number" step="any">
          </label>
          <label>Y Coordinate (Latitude)
            <input id="lat" placeholder="e.g. 52.3740" type="number" step="any">
          </label>
        </div>
        
        <div id="mapInput" style="display: none;">
          <div id="map"></div>
          <div style="margin-top: 8px; font-size: 12px; color: #666;">
            Click on the map to select coordinates
          </div>
        </div>
        
        <div id="gpsInput" style="display: none;">
          <div style="font-size: 12px; color: #666; margin-bottom: 8px;">
            Use your device's GPS location
          </div>
          <button id="getLocation" style="background: #28a745;">Get My Location</button>
        </div>
        
        <label>Height (Z-axis in meters)
          <input id="alt" placeholder="e.g. 20" type="number" step="any" value="20">
        </label>
      </div>
      
      <div id="model-tab" class="tab-content">
        <label>3D Model Source
          <select id="modelSource">
            <option value="github">GitHub Raw Link</option>
            <option value="local">Local File</option>
          </select>
        </label>
        
        <div id="githubInput">
          <label>GitHub Raw GLB URL
            <input id="modelUrl" placeholder="https://raw.githubusercontent.com/..." type="url">
          </label>
        </div>
        
        <div id="localInput" style="display: none;">
          <label>Local Model File
            <input id="localModel" type="file" accept=".glb,.gltf">
          </label>
        </div>
        
        <label>Model Size (meters) — largest dimension
          <input id="meters" placeholder="e.g. 20" type="number" step="any" value="20">
        </label>
      </div>
    </div>

    <button id="generate">Generate AR Link</button>
    <button id="testAR" style="background: #28a745; margin-top: 5px;">Test AR (No GPS Required)</button>
    <button id="testGPS" style="background: #17a2b8; margin-top: 5px;">Test GPS AR (Use My Location)</button>
    <div id="notice">Open the generated link on a mobile device (enable camera & location). For best results use Chrome on Android with WebXR support or modern mobile browsers supporting WebAR.</div>
    <div id="linkOut" style="display:none"></div>
  </div>

  <!-- A-Frame Scene -->
  <a-scene
      vr-mode-ui="enabled: false"
      embedded
      renderer="logarithmicDepthBuffer: true; antialias: true;"
      arjs="sourceType: webcam; debuggingUIEnabled: true; debugUIEnabled: true;"
  >
    <!-- GPS camera - AR.js component with improved settings -->
    <a-camera 
        id="gps-camera" 
        gps-camera 
        rotation-reader 
        look-controls
        gps-camera="simulateLatitude: 0; simulateLongitude: 0;"
    ></a-camera>

    <!-- placeholder container where we will add our model entity programmatically -->
    <a-entity id="model-container"></a-entity>

    <!-- Add some debugging elements -->
    <a-text 
        id="debug-text" 
        value="GPS: Loading..." 
        position="0 2 -1" 
        color="white" 
        align="center"
        visible="true"
    ></a-text>

  </a-scene>

<script>
/*
Enhanced AR Model Placer with:
- Manual coordinate input (X, Y)
- Map-based coordinate selection
- GPS location detection
- GitHub raw GLB link support
- Local file upload support
- Proper scaling in meters
*/

(function(){
  let map = null;
  let selectedCoords = null;
  let modelFile = null;

  // Initialize UI
  function initUI() {
    // Tab switching
    document.querySelectorAll('.tab-button').forEach(btn => {
      btn.addEventListener('click', () => {
        const tab = btn.dataset.tab;
        document.querySelectorAll('.tab-button').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        btn.classList.add('active');
        document.getElementById(tab + '-tab').classList.add('active');
      });
    });

    // Input method switching
    document.getElementById('inputMethod').addEventListener('change', (e) => {
      const method = e.target.value;
      document.getElementById('manualInput').style.display = method === 'manual' ? 'block' : 'none';
      document.getElementById('mapInput').style.display = method === 'map' ? 'block' : 'none';
      document.getElementById('gpsInput').style.display = method === 'gps' ? 'block' : 'none';
      
      if (method === 'map' && !map) {
        initMap();
      }
    });

    // Model source switching
    document.getElementById('modelSource').addEventListener('change', (e) => {
      const source = e.target.value;
      document.getElementById('githubInput').style.display = source === 'github' ? 'block' : 'none';
      document.getElementById('localInput').style.display = source === 'local' ? 'block' : 'none';
    });

    // GPS location
    document.getElementById('getLocation').addEventListener('click', () => {
      if (!navigator.geolocation) {
        alert('Geolocation is not supported by this browser.');
        return;
      }
      
      document.getElementById('getLocation').textContent = 'Getting location...';
      document.getElementById('getLocation').disabled = true;
      
      navigator.geolocation.getCurrentPosition(
        (position) => {
          document.getElementById('lat').value = position.coords.latitude;
          document.getElementById('lon').value = position.coords.longitude;
          document.getElementById('getLocation').textContent = 'Get My Location';
          document.getElementById('getLocation').disabled = false;
        },
        (error) => {
          alert('Error getting location: ' + error.message);
          document.getElementById('getLocation').textContent = 'Get My Location';
          document.getElementById('getLocation').disabled = false;
        }
      );
    });

    // Local file handling
    document.getElementById('localModel').addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (file) {
        const url = URL.createObjectURL(file);
        modelFile = url;
      }
    });
  }

  // Initialize map
  function initMap() {
    if (map) return;
    
    map = L.map('map').setView([52.3740, 4.8897], 13);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '© OpenStreetMap contributors'
    }).addTo(map);
    
    map.on('click', (e) => {
      if (selectedCoords) {
        map.removeLayer(selectedCoords);
      }
      
      selectedCoords = L.marker([e.latlng.lat, e.latlng.lng]).addTo(map);
      document.getElementById('lat').value = e.latlng.lat.toFixed(6);
      document.getElementById('lon').value = e.latlng.lng.toFixed(6);
    });
  }

  // Parse query params
  function getParams(){
    const p = new URLSearchParams(window.location.search);
    return {
      lat: p.get('lat'),
      lon: p.get('lon'),
      alt: p.get('alt'),
      meters: p.get('meters'),
      model: p.get('model')
    };
  }

  // Build shareable link
  document.getElementById('generate').addEventListener('click', ()=>{
    const lat = document.getElementById('lat').value.trim();
    const lon = document.getElementById('lon').value.trim();
    const alt = document.getElementById('alt').value.trim();
    const meters = document.getElementById('meters').value.trim();
    const modelUrl = document.getElementById('modelUrl').value.trim();
    
    if(!lat || !lon || !meters){ 
      alert('Please enter coordinates and model size.'); 
      return; 
    }
    
    if(!modelUrl && !modelFile){ 
      alert('Please provide a model URL or select a local file.'); 
      return; 
    }
    
    const url = new URL(window.location.href.split('?')[0]);
    url.searchParams.set('lat', lat);
    url.searchParams.set('lon', lon);
    url.searchParams.set('alt', alt || '0');
    url.searchParams.set('meters', meters);
    if (modelUrl) {
      url.searchParams.set('model', modelUrl);
    }
    
    const linkOut = document.getElementById('linkOut');
    linkOut.style.display='block';
    linkOut.textContent = url.toString();
    linkOut.onclick = ()=> navigator.clipboard?.writeText(url.toString());
  });

  // Test AR button - bypasses GPS completely
  document.getElementById('testAR').addEventListener('click', ()=>{
    // Hide UI
    document.getElementById('ui').style.display='none';
    
    // Add test objects at fixed positions (no GPS required)
    const container = document.getElementById('model-container');
    while(container.firstChild) container.removeChild(container.firstChild);
    
    // Add a simple test model at fixed position
    const testModel = document.createElement('a-entity');
    testModel.setAttribute('geometry', 'primitive: box; width: 2; height: 2; depth: 2');
    testModel.setAttribute('material', 'color: orange; opacity: 0.8');
    testModel.setAttribute('position', '0 1 -3'); // 3 meters in front, 1 meter up
    testModel.setAttribute('id', 'test-model');
    container.appendChild(testModel);
    
    // Add some text
    const testText = document.createElement('a-text');
    testText.setAttribute('value', 'AR Test Mode - No GPS Required');
    testText.setAttribute('position', '0 2 -2');
    testText.setAttribute('color', 'white');
    testText.setAttribute('align', 'center');
    container.appendChild(testText);
    
    console.log('Test AR mode activated - objects should be visible');
  });

  // Test GPS AR button - uses current location
  document.getElementById('testGPS').addEventListener('click', ()=>{
    if (!navigator.geolocation) {
      alert('Geolocation is not supported by this browser.');
      return;
    }
    
    document.getElementById('testGPS').textContent = 'Getting location...';
    document.getElementById('testGPS').disabled = true;
    
    navigator.geolocation.getCurrentPosition(
      (position) => {
        const lat = position.coords.latitude;
        const lon = position.coords.longitude;
        
        // Fill in the coordinates
        document.getElementById('lat').value = lat;
        document.getElementById('lon').value = lon;
        document.getElementById('alt').value = '5'; // 5 meters high
        document.getElementById('meters').value = '3'; // 3 meters size
        
        // Hide UI and place model
        document.getElementById('ui').style.display='none';
        
        // Place model at current location
        const params = {
          lat: lat.toString(),
          lon: lon.toString(),
          alt: '5',
          meters: '3'
        };
        
        placeModelFromParams(params);
        
        document.getElementById('testGPS').textContent = 'Test GPS AR (Use My Location)';
        document.getElementById('testGPS').disabled = false;
      },
      (error) => {
        alert('Error getting location: ' + error.message);
        document.getElementById('testGPS').textContent = 'Test GPS AR (Use My Location)';
        document.getElementById('testGPS').disabled = false;
      }
    );
  });

  // Helper: load GLTF via THREE's loader used inside A-Frame
  function loadGLTF(path){
    return new Promise((resolve, reject)=>{
      const loader = new THREE.GLTFLoader();
      loader.load(path, gltf => resolve(gltf), undefined, err => reject(err));
    });
  }

  // Helper: get model path from params or UI
  function getModelPath(params) {
    if (params.model) {
      return params.model;
    }
    
    const modelUrl = document.getElementById('modelUrl').value.trim();
    if (modelUrl) {
      return modelUrl;
    }
    
    if (modelFile) {
      return modelFile;
    }
    
    // Fallback to local files
    const modelFileCandidates = ['batman.glb','batman.gltf'];
    return modelFileCandidates[0];
  }

  async function placeModelFromParams(params){
    if(!params.lat || !params.lon || !params.meters) return;

    const modelPath = getModelPath(params);
    console.log('Placing model at:', params.lat, params.lon, 'height:', params.alt, 'size:', params.meters);

    // Update debug text
    const debugText = document.getElementById('debug-text');
    if(debugText) {
      debugText.setAttribute('value', `Placing model at ${params.lat}, ${params.lon}`);
    }

    // Create entity for gps-entity-place
    const container = document.getElementById('model-container');
    // Remove existing children if any
    while(container.firstChild) container.removeChild(container.firstChild);

    const entity = document.createElement('a-entity');
    entity.setAttribute('gps-entity-place', `latitude: ${params.lat}; longitude: ${params.lon};`);
    // Apply a position Y for altitude (AR.js examples often use position="0 ALT 0")
    entity.setAttribute('position', `0 ${Number(params.alt||0)} 0`);
    // Add gltf-model attribute but we'll load and then adjust scale after computing bounding box
    entity.setAttribute('gltf-model', modelPath);
    // Give id so we can refer to it later
    entity.setAttribute('id','gltf-model-entity');

    // Optionally rotate to an initial orientation
    entity.setAttribute('rotation', '0 0 0');

    // Add some visual indicators for debugging
    entity.setAttribute('material', 'color: red; opacity: 0.8');
    entity.setAttribute('geometry', 'primitive: box; width: 1; height: 1; depth: 1');

    container.appendChild(entity);

    // Wait for model to load in scene, then compute bounding box and scale
    // Use THREE loader to compute bounding box
    try {
      const gltf = await loadGLTF(modelPath);
      const sceneObj = gltf.scene || gltf.scenes[0];
      if(!sceneObj){
        console.warn('No scene in gltf');
        return;
      }

      // Compute bounding box
      const box = new THREE.Box3().setFromObject(sceneObj);
      const size = new THREE.Vector3();
      box.getSize(size);
      const maxDim = Math.max(size.x, size.y, size.z);
      // If model has zero size (bad export), default maxDim=1
      const safeMax = (maxDim <= 0 || isNaN(maxDim)) ? 1 : maxDim;

      const desiredMeters = Number(params.meters);
      const scaleFactor = desiredMeters / safeMax;

      // Wait until the entity's object3D exists in the A-Frame scene (frame loop)
      const afEntity = document.getElementById('gltf-model-entity');
      const waitForObj = () => new Promise(res=>{
        const t0 = performance.now();
        (function check(){
          if(afEntity && afEntity.object3D && afEntity.object3D.children.length>0){
            res();
          } else {
            if(performance.now() - t0 > 10000){ res(); } else requestAnimationFrame(check);
          }
        })();
      });
      await waitForObj();

      // Set uniform scale on the loaded model object (apply to the first child)
      // We prefer to scale the actual glTF root so A-Frame's position/rotation remain consistent.
      const targetObj = afEntity.object3D;
      targetObj.scale.set(scaleFactor, scaleFactor, scaleFactor);

      // Optionally tilt/rotate the model so its base aligns with ground
      // If model's pivot is not at base, user may need to adjust via additional UI.
      // Ensure model faces camera initially by rotating to camera heading (best effort)
      // We'll set up an interval to make it face the camera horizontally
      const camera = document.getElementById('gps-camera');
      if(camera){
        const orientToCamera = () => {
          try {
            const camPos = new THREE.Vector3();
            camera.object3D.getWorldPosition(camPos);
            const modelPos = new THREE.Vector3();
            afEntity.object3D.getWorldPosition(modelPos);
            const dx = camPos.x - modelPos.x;
            const dz = camPos.z - modelPos.z;
            const yaw = Math.atan2(dx, dz) * (180/Math.PI);
            afEntity.object3D.rotation.y = yaw * (Math.PI/180);
          } catch(e){}
        };
        // Call once and then on deviceorientation events / every second
        orientToCamera();
        const orientInterval = setInterval(orientToCamera, 1500);
        // Clear after 20s to avoid endless work
        setTimeout(()=> clearInterval(orientInterval), 20000);
      }

      console.log('Placed model', {modelPath, scaleFactor, safeMax});
    } catch(err){
      console.error('Error loading model', err);
      alert('Failed to load model file. Please check the URL or file path.');
    }
  }

  // Add GPS debugging and fallback positioning
  function setupGPSDebugging() {
    const camera = document.getElementById('gps-camera');
    if (!camera) return;

    // Monitor GPS status
    let gpsStatus = 'Waiting for GPS...';
    const debugText = document.getElementById('debug-text');
    
    const updateGPSStatus = () => {
      if (camera.components && camera.components['gps-camera']) {
        const gpsCamera = camera.components['gps-camera'];
        if (gpsCamera.data) {
          gpsStatus = `GPS: ${gpsCamera.data.latitude?.toFixed(6) || 'N/A'}, ${gpsCamera.data.longitude?.toFixed(6) || 'N/A'}`;
        }
      }
      if (debugText) {
        debugText.setAttribute('value', gpsStatus);
      }
    };

    // Update status every second
    setInterval(updateGPSStatus, 1000);
    
    // Add event listeners for GPS updates
    camera.addEventListener('gps-camera-update-pos', (e) => {
      console.log('GPS Update:', e.detail);
      gpsStatus = `GPS: ${e.detail.latitude?.toFixed(6)}, ${e.detail.longitude?.toFixed(6)}`;
      if (debugText) {
        debugText.setAttribute('value', gpsStatus);
      }
    });
  }

  // Add fallback positioning for testing
  function addFallbackPositioning() {
    const params = getParams();
    if (!params.lat || !params.lon) return;

    // Add multiple test objects at different distances
    const container = document.getElementById('model-container');
    
    // Test box 1: Close (2 meters)
    const testEntity1 = document.createElement('a-entity');
    testEntity1.setAttribute('geometry', 'primitive: box; width: 1; height: 1; depth: 1');
    testEntity1.setAttribute('material', 'color: red; opacity: 0.9');
    testEntity1.setAttribute('position', '0 0.5 -2'); // 2 meters in front
    testEntity1.setAttribute('id', 'test-entity-close');
    container.appendChild(testEntity1);

    // Test box 2: Medium (5 meters)
    const testEntity2 = document.createElement('a-entity');
    testEntity2.setAttribute('geometry', 'primitive: box; width: 1.5; height: 1.5; depth: 1.5');
    testEntity2.setAttribute('material', 'color: green; opacity: 0.9');
    testEntity2.setAttribute('position', '0 0.75 -5'); // 5 meters in front
    testEntity2.setAttribute('id', 'test-entity-medium');
    container.appendChild(testEntity2);

    // Test box 3: Far (10 meters)
    const testEntity3 = document.createElement('a-entity');
    testEntity3.setAttribute('geometry', 'primitive: box; width: 2; height: 2; depth: 2');
    testEntity3.setAttribute('material', 'color: blue; opacity: 0.9');
    testEntity3.setAttribute('position', '0 1 -10'); // 10 meters in front
    testEntity3.setAttribute('id', 'test-entity-far');
    container.appendChild(testEntity3);

    console.log('Added test entities for debugging at 2m, 5m, and 10m');
  }

  // On load, initialize UI and handle AR placement
  window.addEventListener('load', ()=>{
    initUI();
    
    const params = getParams();
    if(params.lat && params.lon && params.meters){
      // Hide UI to let AR view be fullscreen when viewing AR
      document.getElementById('ui').style.display='none';
      
      // Setup debugging
      setupGPSDebugging();
      addFallbackPositioning();
      
      // Place the actual model
      placeModelFromParams(params);
    }
  });

})();
</script>
</body>
</html>

