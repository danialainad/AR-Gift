<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>AR Gift GPS</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <!-- A-Frame & AR.js -->
    <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
    <script src="https://unpkg.com/aframe-look-at-component@0.8.0/dist/aframe-look-at-component.min.js"></script>
    <script src="https://unpkg.com/aframe-ar@3.3.2/dist/aframe-ar.min.js"></script>
    <script src="https://unpkg.com/aframe-gps-camera/dist/aframe-gps-camera.min.js"></script>
    <script src="https://unpkg.com/aframe-gps-entity-place/dist/aframe-gps-entity-place.min.js"></script>

    <style>
      body {
        margin: 0;
        overflow: hidden;
        font-family: sans-serif;
      }
      #setupPanel {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.9);
        color: white;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        z-index: 5;
      }
      #setupPanel input {
        margin: 6px;
        padding: 8px;
        width: 260px;
      }
      #setupPanel button {
        padding: 10px 20px;
        margin-top: 10px;
        background: #00bcd4;
        border: none;
        color: white;
        cursor: pointer;
        font-size: 16px;
      }
      #loadingMsg {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        color: white;
        font-size: 18px;
        background: rgba(0, 0, 0, 0.5);
        padding: 12px 20px;
        border-radius: 10px;
        z-index: 2;
      }
    </style>
  </head>
  <body>
    <!-- Setup panel (visible only when no query params) -->
    <div id="setupPanel">
      <h2>Place Your AR Gift üéÅ</h2>
      <input id="modelUrl" type="text" placeholder="Model URL (.glb)" />
      <input id="latitude" type="number" step="0.000001" placeholder="Latitude" />
      <input id="longitude" type="number" step="0.000001" placeholder="Longitude" />
      <input id="altitude" type="number" step="0.1" placeholder="Altitude (meters)" />
      <input id="size" type="number" step="0.1" placeholder="Size (meters)" />
      <button id="generateBtn">Generate Share Link</button>
      <div id="linkContainer" style="margin-top:15px;"></div>
    </div>

    <!-- Loading message -->
    <div id="loadingMsg">üì∑ Waiting for camera and GPS...</div>

    <!-- AR Scene -->
    <a-scene
      embedded
      vr-mode-ui="enabled: false"
      renderer="antialias: true; alpha: true;"
      arjs="sourceType: webcam; debugUIEnabled: false;"
    >
      <a-entity gps-camera rotation-reader></a-entity>
    </a-scene>

    <script>
      const urlParams = new URLSearchParams(window.location.search);
      const modelUrl = urlParams.get("model");
      const lat = parseFloat(urlParams.get("lat"));
      const lon = parseFloat(urlParams.get("lon"));
      const alt = parseFloat(urlParams.get("alt")) || 0;
      const size = parseFloat(urlParams.get("size")) || 10;

      const setupPanel = document.getElementById("setupPanel");
      const loadingMsg = document.getElementById("loadingMsg");

      if (modelUrl && lat && lon) {
        // Hide setup panel
        setupPanel.style.display = "none";
        loadingMsg.style.display = "block";

        // Wait for A-Frame to be ready
        document.querySelector("a-scene").addEventListener("loaded", () => {
          const scene = document.querySelector("a-scene");

          const model = document.createElement("a-entity");
          model.setAttribute("gltf-model", modelUrl);
          model.setAttribute("gps-entity-place", `latitude: ${lat}; longitude: ${lon}; altitude: ${alt}`);
          model.setAttribute("scale", `${size} ${size} ${size}`);
          model.setAttribute("rotation", "0 180 0");
          scene.appendChild(model);

          window.addEventListener("gps-camera-update-position", (e) => {
            loadingMsg.style.display = "none";
          });
        });
      } else {
        // Setup mode
        loadingMsg.style.display = "none";
        document.getElementById("generateBtn").addEventListener("click", () => {
          const m = document.getElementById("modelUrl").value.trim();
          const la = document.getElementById("latitude").value.trim();
          const lo = document.getElementById("longitude").value.trim();
          const al = document.getElementById("altitude").value.trim() || 0;
          const s = document.getElementById("size").value.trim() || 10;

          if (!m || !la || !lo) {
            alert("Please fill in model URL, latitude, and longitude.");
            return;
          }

          const link = `${window.location.origin}${window.location.pathname}?model=${encodeURIComponent(
            m
          )}&lat=${la}&lon=${lo}&alt=${al}&size=${s}`;

          document.getElementById(
            "linkContainer"
          ).innerHTML = `<p>Share this link:</p><a href="${link}" target="_blank" style="color:#00bcd4;">${link}</a>`;
        });
      }
    </script>
  </body>
</html>
